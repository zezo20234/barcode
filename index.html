<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Secret Code Generator — Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:800px;margin:20px auto;padding:16px;background:#f7fbff;}
  h1{color:#2b4c7e}
  label{display:block;margin-top:12px;font-weight:700}
  input, select, button {padding:10px;border-radius:8px;border:1px solid #ccc;width:100%;box-sizing:border-box}
  .row{display:flex;gap:10px}
  .row>div{flex:1}
  .codesList{margin-top:16px;background:white;padding:12px;border-radius:8px;border:1px solid #e0e0e0}
  .codeItem{padding:8px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
  .small{font-size:0.9rem;color:#555}
  .danger{background:#ff4b4b;color:white;border:none;padding:8px 10px;border-radius:6px}
</style>
</head>
<body>
  <h1>Secret Code Generator</h1>
  <p class="small">Create 5-digit secret codes that open the secret shop. Choose expiry by date/time or by max purchases.</p>

  <label>Created by (username)</label>
  <input id="createdBy" placeholder="your admin username (optional)" />

  <label>Expiry type</label>
  <select id="expiryType">
    <option value="none">No expiry</option>
    <option value="datetime">Expiry by date/time</option>
    <option value="purchases">Expiry by maximum purchases</option>
    <option value="both">Both (datetime + purchases limit)</option>
  </select>

  <div id="datetimeRow" style="display:none;">
    <label>Expiry date & time (local)</label>
    <input id="expiryDatetime" type="datetime-local" />
  </div>

  <div id="purchasesRow" style="display:none;">
    <label>Max purchases (integer)</label>
    <input id="purchasesLimit" type="number" min="1" placeholder="e.g. 5" />
  </div>

  <label>Quantity (how many distinct 5-digit codes to create)</label>
  <input id="quantity" type="number" min="1" value="1" />

  <button id="generateBtn">Generate Code(s)</button>

  <div style="margin-top:14px;">
    <button id="listBtn">Refresh list</button>
    <button id="deleteAllBtn" class="danger" style="float:right;">Delete ALL codes</button>
  </div>

  <div class="codesList" id="codesList">Loading...</div>

<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// same firebase config as your app
const firebaseConfig = {
  apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
  authDomain: "sharplabubu.firebaseapp.com",
  databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
  projectId: "sharplabubu",
  storageBucket: "sharplabubu.firebasestorage.app",
  messagingSenderId: "596148393481",
  appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
  measurementId: "G-4M25R3BF08"
};

let app;
try { app = getApp(); } catch (e) { app = initializeApp(firebaseConfig); }
const db = getDatabase(app);

const expiryTypeEl = document.getElementById('expiryType');
const datetimeRow = document.getElementById('datetimeRow');
const purchasesRow = document.getElementById('purchasesRow');
expiryTypeEl.addEventListener('change', ()=> {
  const v = expiryTypeEl.value;
  datetimeRow.style.display = (v === 'datetime' || v === 'both') ? 'block' : 'none';
  purchasesRow.style.display = (v === 'purchases' || v === 'both') ? 'block' : 'none';
});

function random5digits(){
  return Math.floor(10000 + Math.random()*90000).toString();
}

async function codeExists(code){
  const snap = await get(ref(db, `secretCodes/${code}`));
  return snap.exists();
}

async function createSingleCode({ code, createdBy, expiryMs=null, purchasesLimit=null }){
  const payload = {
    code,
    createdBy: createdBy || 'admin',
    createdAt: Date.now(),
    expiry: expiryMs || null,
    purchasesLimit: purchasesLimit != null ? Number(purchasesLimit) : null,
    used: 0
  };
  // write under key = code for easy lookup
  await set(ref(db, `secretCodes/${code}`), payload);
  return payload;
}

document.getElementById('generateBtn').addEventListener('click', async ()=>{
  const qty = Math.max(1, parseInt(document.getElementById('quantity').value) || 1);
  const type = expiryTypeEl.value;
  const createdBy = document.getElementById('createdBy').value || 'admin';
  let expiryMs = null;
  let purchasesLimit = null;
  if(type === 'datetime' || type === 'both'){
    const dt = document.getElementById('expiryDatetime').value;
    if(!dt) return alert('Please pick expiry date/time');
    expiryMs = new Date(dt).getTime();
  }
  if(type === 'purchases' || type === 'both'){
    purchasesLimit = parseInt(document.getElementById('purchasesLimit').value);
    if(!purchasesLimit || purchasesLimit < 1) return alert('Please enter a valid purchases limit');
  }

  const created = [];
  for(let i=0;i<qty;i++){
    let tries = 0;
    while(true){
      tries++;
      const c = random5digits();
      const exists = await codeExists(c);
      if(!exists){
        const payload = await createSingleCode({ code: c, createdBy, expiryMs, purchasesLimit });
        created.push(payload);
        break;
      }
      if(tries > 10) { alert('Failed to generate unique code after multiple attempts'); break; }
    }
  }
  if(created.length) {
    alert(`Created ${created.length} new code(s).`);
    listCodes();
  }
});

async function listCodes(){
  const snap = await get(ref(db, 'secretCodes'));
  const container = document.getElementById('codesList');
  container.innerHTML = '';
  if(!snap.exists()){ container.innerHTML = '<div class="small">No codes yet.</div>'; return; }
  const all = snap.val();
  const entries = Object.entries(all).sort((a,b)=> a[0].localeCompare(b[0]));
  entries.forEach(([code, data])=>{
    const div = document.createElement('div'); div.className = 'codeItem';
    const left = document.createElement('div');
    const right = document.createElement('div');
    left.innerHTML = `<strong>${code}</strong> <div class="small">created: ${new Date(data.createdAt).toLocaleString()}</div>`;
    const meta = [];
    if(data.expiry) meta.push(`expires: ${new Date(data.expiry).toLocaleString()}`);
    if(data.purchasesLimit != null) meta.push(`limit: ${data.purchasesLimit}`);
    meta.push(`used: ${data.used||0}`);
    left.innerHTML += `<div class="small">${meta.join(' • ')}</div>`;
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.style.marginLeft='8px';
    delBtn.addEventListener('click', async ()=> { if(!confirm('Delete code '+code+' ?')) return; await remove(ref(db, `secretCodes/${code}`)); listCodes(); });
    right.appendChild(delBtn);
    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

document.getElementById('listBtn').addEventListener('click', ()=> listCodes());
document.getElementById('deleteAllBtn').addEventListener('click', async ()=>{
  if(!confirm('Delete ALL secret codes? This cannot be undone.')) return;
  await set(ref(db, 'secretCodes'), null);
  listCodes();
});

listCodes();

</script>
</body>
</html>
